<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
    <head>
        <title>maproulette</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
         <link type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/themes/redmond/jquery-ui.css" rel="stylesheet" /> 
         <style type="text/css">
			html, body {
			  height: 100%;
			  margin: 0;
			  padding: 0;
			}
			
			#map_canvas {
			  height: 80%;
			}
			
			@media print {
			  html, body {
				height: auto;
			  }
			
			  #map_canvas {
				height: 650px;
			  }
			}
			
			#progressbar {
				height: 15px;
				width: 200px;	
			}
			
			#directions-panel {
				height: 80%;
				float: right;
				width: 390px;
				overflow: auto;
			}
			
			#map-canvas {
				margin-right: 400px;
			}
			
			#control {
				background: #fff;
				padding: 5px;
				font-size: 14px;
				font-family: Arial;
				border: 1px solid #ccc;
				box-shadow: 0 2px 2px rgba(33, 33, 33, 0.4);
				display: none;
			}
			
			@media print {
				#map-canvas {
					height: 500px;
					margin: 0;
				}
				
				#directions-panel {
					float: none;
					width: auto;
				}
			}
		</style>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyCXAjl_EPBIDiPzgd2Kzsn4ExvlUidESPA&sensor=true"></script>
        <script type="text/javascript">
            var map;
            var initialLocation = new google.maps.LatLng(41.2, -112);
            var Geostart = "";
            var directionsDisplay;
            var directionsService = new google.maps.DirectionsService();
            var geoJSON = "http://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyCXAjl_EPBIDiPzgd2Kzsn4ExvlUidESPA&sensor=true&address=";
            var fsq = "https://api.foursquare.com/v2/venues/explore?ll=";
            var fsqpoints = "&limit=";
            var fsqcaturl = "&section=";
            var fsqcats;
            var fsqqryurl = "&query=";
            var fsqqry;
            var fsqrecurl = "&novelty=";
            var fsqrec;
            var placesJSON = "https://maps.googleapis.com/maps/api/place/search/json?sensor=true&key=AIzaSyCXAjl_EPBIDiPzgd2Kzsn4ExvlUidESPA&location=";
            var placesJSONend = "&rankby=distance&types=establishment"; //radius=";
            var start, end;
            var startLL, endLL;
            var geocoder = new google.maps.Geocoder();
            var waypoints;
            var waynames;
            var maxWaypoints = 8;
            var numWaypoints;
            var convMiLL = 69; 			// 69 miles = 1 latitude/longitude (average)
            var convLLMi = 0.000621371192; // conversion factor for lat/long to miles
            var convMim = 1760; 			// rough miles to meters
            var rise, run, distance, wpDist, risestep, runstep, rad;
            var fsq_token;
            var isFSQ;
            var isDev;

            var fsqconfig = {
                //dev
                apiKeyDev: 'GWCCYYFINDKJ1A3JUY0KMUAEXX5UQ0EGHTQPPGUGLTVAKNUK',
                // prod
                apiKey: 'UMGTNRDSNZV2WY1TE5WWLSLMS1UAMH4YCYJFXHEPSKKXVHYA',
                authUrl: 'https://foursquare.com/',
                apiUrl: 'https://api.foursquare.com/'
            };

            function doAuthRedirect() {
                var pgurl = document.URL;
                var redirect = window.location.href.replace(window.location.hash, '');
                var url = fsqconfig.authUrl + 'oauth2/authenticate?response_type=token&client_id=';
                if(pgurl.indexOf("localhost") != -1) {
                    url += fsqconfig.apiKeyDev;
                } else {
                    url += fsqconfig.apiKey;
                }
                url += '&redirect_uri=' + encodeURIComponent(redirect);
                window.location.href = url;
            };

            function initialize() {
                isFSQ = false;
                isDev = false;
                var pgurl = document.URL;
                if(pgurl.indexOf('access_token') != -1) {
                    var splitres = pgurl.split('access_token=');
                    fsq_token = splitres[1];
                    $('div.foursquare').html('logged into <a href="http://www.foursquare.com/">foursquare</a>');
                    isFSQ = true;
                }
                if(pgurl.indexOf("localhost") != -1) {
                    isDev = true;
                }
                //directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});
                directionsDisplay = new google.maps.DirectionsRenderer();
                var mapOptions = {
                    zoom: 12,
                    center: initialLocation,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
                directionsDisplay.setMap(map);
                directionsDisplay.setPanel(document.getElementById('directions-panel'));

                // Try W3C Geolocation (Preferred)
                if(navigator.geolocation) {
                    browserSupportFlag = true;
                    navigator.geolocation.getCurrentPosition(function(position) {
                        initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                        map.setCenter(initialLocation);
                        Geostart = initialLocation.toUrlValue();
                        if(!isDev) {
                            document.getElementById('fsqstart').value = Geostart;
                            document.getElementById('regstart').value = Geostart;
                        }
                        marker = new google.maps.Marker({
                            position: initialLocation,
                            map: map
                        });
                    }, function() {
                        map.setCenter(initialLocation);
                    });
                    // Browser doesn't support Geolocation
                } else {
                    map.setCenter(initialLocation);
                }


                var control = document.getElementById('control');
                control.style.display = 'block';
                //map.controls[google.maps.ControlPosition.TOP].push(control);

                //click to add a marker
                /*
                google.maps.event.addListener(map, 'click', function(event) {
                placeMarker(event.latLng);
                });
                */
                if(isFSQ) {
                    $('#regroute').hide('fast');
                } else {
                    $('#fsqroute').hide('fast');
                }
                /*
                if((Geostart != "") && (!isDev)) {
                document.getElementById('fsqstart').value = Geostart;
                document.getElementById('regstart').value = Geostart;
                }
                */
            }

            function getRoute(form) {
                document.getElementById("gobtn").disabled = true;
                $("#notifications").hide('fast');
                waypoints = new Array();
                waynames = new Array();
                start = $.trim(form.start.value);
                end = $.trim(form.end.value);
                if((start == "") || (end == "")) {
                    $("#notifications").show('fast');
                    $("#notifications").html("whoops! please enter both start and end points!");
                    document.getElementById("gobtn").disabled = false;
                } else {
                    if(isFSQ) {
                        fsqcats = form.categories[form.categories.selectedIndex].value;
                        fsqqry = $.trim(form.search.value);
                        if(form.newrec.checked) {
                            if(form.oldrec.checked) {
                                fsqrec = "both";
                            } else {
                                fsqrec = form.newrec.value;
                            }
                        } else {
                            fsqrec = form.oldrec.value;
                        }
                    }
                    loadWaypoints(start, end);
                    //getDirections();
                }
            }

            function loadWaypoints(orig, dest) {
                numWaypoints = Math.round(Math.random() * 100) % maxWaypoints;
                $("#progressbar").show('fast');
                $("#progressbar").progressbar({ value: 0 });
                //waypoints[0] = orig;
                //waypoints[numWaypoints - 1] = dest;

                geocoder.geocode({ 'address': orig }, function(results, status) {
                    if(status == google.maps.GeocoderStatus.OK) {
                        startLL = results[0].geometry.location;
                        nextWaypoint(startLL, 0);
                        /*
                        map.setCenter(startLL);
                        var marker = new google.maps.Marker({
                        map: map,
                        position: startLL
                        });
                        */
                    } else {
                        console.log("Geocode start was not successful: " + status);
                        $.ajax({
                            url: geoJSON + orig,
                            dataType: 'json',
                            success: function(data) {
                                if(data.status == google.maps.GeocoderStatus.OK) {
                                    startLL = data.results[0].geometry.location;
                                    nextWaypoint(startLL, 0);
                                } else {
                                    console.log("Geocode start URL failed:" + data.status);
                                    $("#notifications").show('fast');
                                    $("#notifications").html("whoops! couldn't geocode start. try again!");
                                    document.getElementById("gobtn").disabled = false;
                                }
                            },
                            error: function(data) {
                                errfunc(data);
                            }
                        });
                    }
                });
            }

            function nextWaypoint(point, cur) {
                var lat;
                var lng;

                if(cur == (numWaypoints + 2)) {
                    $("#progressbar").progressbar({ value: 100 });
                    getDirections();
                } else if(cur == 0) {
                    geocoder.geocode({ 'address': end }, function(results, status) {
                        if(status == google.maps.GeocoderStatus.OK) {
                            endLL = results[0].geometry.location;
                            rise = (startLL.lng() - endLL.lng());
                            run = (startLL.lat() - endLL.lat());
                            slope = rise / run;
                            risestep = rise / numWaypoints;
                            runstep = run / numWaypoints;
                            distance = Math.sqrt(rise * rise + run * run) * convMiLL;
                            wpDist = distance / numWaypoints;
                            if(numWaypoints == 0) wpDist = distance;
                            rad = Math.round(wpDist * convMim) / 2;
                            if(rad > 35000) rad = 35000;
                            $("#progressbar").progressbar({ value: Math.round((cur / (numWaypoints + 2)) * 100) });
                            nextWaypoint(point, 1);
                        } else {
                            console.log("Geocode dest failed:" + data.status);
                            $.ajax({
                                url: geoJSON + end,
                                dataType: 'json',
                                success: function(data) {
                                    if(data.status == google.maps.GeocoderStatus.OK) {
                                        endLL = data.results[0].geometry.location;
                                        rise = (startLL.lng() - endLL.lng());
                                        run = (startLL.lat() - endLL.lat());
                                        slope = rise / run;
                                        risestep = rise / numWaypoints;
                                        runstep = run / numWaypoints;
                                        distance = Math.sqrt(rise * rise + run * run) * convMiLL;
                                        wpDist = distance / numWaypoints;
                                        if(numWaypoints == 0) wpDist = distance;
                                        rad = Math.round(wpDist * convMim) / 2;
                                        if(rad > 35000) rad = 35000;
                                        $("#progressbar").progressbar({ value: Math.round((cur / (numWaypoints + 2)) * 100) });
                                        nextWaypoint(point, 1);
                                    } else {
                                        console.log("Geocode URL dest failed:" + data.status);
                                        $("#notifications").show('fast');
                                        $("#notifications").html("whoops! couldn't geocode end. try again!");
                                        document.getElementById("gobtn").disabled = false;
                                    }
                                },
                                error: function(data) {
                                    errfunc(data);
                                }
                            });
                        }
                    });
                } else {
                    $("#progressbar").progressbar({ value: Math.round((cur / (numWaypoints + 2)) * 100) });
                    lat = point.lat();
                    lng = point.lng();
                    nextWP = new google.maps.LatLng(lat - runstep, lng - risestep);

                    // Randomize lat/long
                    if(Math.random() > 0.5) {
                        lat = lat + (Math.random() * (runstep / 4));
                        //lat = lat + (((Math.random() * convMiLL) % (wpDist)) * convLLMi);
                    } else {
                        lat = lat - (Math.random() * (runstep / 4));
                        //lat = lat - (((Math.random() * convMiLL) % (wpDist)) * convLLMi);
                    }
                    if(Math.random() > 0.5) {
                        lng = lng + (Math.random() * (risestep / 4));
                        //lng = lng + (((Math.random() * convMiLL) % (wpDist)) * convLLMi);
                    } else {
                        lng = lng - (Math.random() * (risestep / 4));
                        //lng = lng - (((Math.random() * convMiLL) % (wpDist)) * convLLMi);
                    }
                    newPoint = new google.maps.LatLng(lat, lng);
                    if(isFSQ) {
                        // Foursquare API plugin, must be authenticated with oAuth
                        var fsqurl = fsq + newPoint.toUrlValue() + fsqpoints + maxWaypoints + '&oauth_token=' + fsq_token + "&v=20120801";
                        if(fsqcats != "all") {
                            fsqurl += fsqcaturl + fsqcats;
                            //rad = rad * 2;
                        }
                        if(fsqqry != "") {
                            fsqurl += fsqqryurl + encodeURIComponent(fsqqry);
                            //rad = rad * 2;
                        }
                        if(fsqrec != "both") {
                            fsqurl += fsqrecurl + fsqrec;
                        }
                        fsqurl += "&radius=" + rad;
                        $.ajax({
                            url: fsqurl,
                            dataType: 'json',
                            success: function(data) {
                                if(typeof data['response']['warning'] != "undefined") {
                                    console.log(data['response']['warning']);
                                    console.log("trying again, with bigger radius");
                                    var splitres = fsqurl.split('&radius=');
                                    newurl = splitres[0];
                                    newurl += "&radius=" + (rad * 2).toString();
                                    //newurl.replace(rad.toString, (rad * 2));
                                    $.ajax({
                                        url: newurl,
                                        dataType: 'json',
                                        success: function(newdata) {
                                            if(typeof newdata['response']['warning'] != "undefined") {
                                                console.log(newdata['response']['warning']);
                                                waynames[cur - 1] = "N/A";
                                                waypoints[cur - 1] = {
                                                    location: newPoint.toUrlValue(),
                                                    stopover: true
                                                };
                                            } else {
                                                storeFsqWaypoint(newdata, cur);
                                            }
                                            nextWaypoint(nextWP, cur + 1);
                                        },
                                        error: function(newdata) {
                                            errfunc(newdata);
                                        }
                                    });
                                } else {
                                    storeFsqWaypoint(data, cur);
                                    nextWaypoint(nextWP, cur + 1);
                                }
                            },
                            error: function(data) {
                                errfunc(data);
                            }
                        });
                    } else {
                        /*
                        // Google Places API
                        var placesurl = placesJSON + newPoint.toUrlValue() + placesJSONend; // + rad;
                        $.getJSON(placesurl, function(data) {
                        if(data.status == google.maps.GeocoderStatus.OK) {
                        waypoints[cur - 1] = {
                        location: data.results[0].name + ',' + data.results[0].vicinity,
                        stopover: true
                        };
                        } else {
                        console.log("Places API failed: " + data.status);
                        waypoints[cur - 1] = {
                        location: newPoint.toUrlValue(),
                        stopover: true
                        };
                        }
                        nextWaypoint(nextWP, cur + 1);
                        });
                        */
                        waypoints[cur - 1] = {
                            location: newPoint.toUrlValue(),
                            stopover: true
                        };
                        nextWaypoint(nextWP, cur + 1);
                    }
                }
            }

            function getDirections() {
                waypoints.splice(0, 1);
                waypoints.splice(waypoints.length - 1, 1);
                var dirrequest = {
                    origin: start,
                    destination: end,
                    waypoints: this.waypoints,
                    provideRouteAlternatives: false,
                    travelMode: google.maps.TravelMode.DRIVING
                };
                directionsService.route(dirrequest, function(dirresult, dirstatus) {
                    if(dirstatus == google.maps.DirectionsStatus.OK) {
                        if(isFSQ) {
                            directionsDisplay.setDirections(modAddresses(dirresult));
                        } else {
                            directionsDisplay.setDirections(dirresult);
                        }
                    } else {
                        $("#notifications").show('fast');
                        $("#notifications").html("whoops! couldn't get directions. try again!");
                        console.log("Directions was not successful for the following reason: " + dirstatus);
                    }
                });
                $("#progressbar").hide('fast');
                document.getElementById("gobtn").disabled = false;
            }

            function storeFsqWaypoint(data, cur) {
                var name = data['response']['groups'][0]['items'][0]['venue']['name'];
                var pl = 0;

                while(waynames.indexOf(name) != -1) {
                    pl++;
                    name = data['response']['groups'][0]['items'][pl]['venue']['name'];
                }

                var loc = data['response']['groups'][0]['items'][pl]['venue']['name'];
                loc += ", " + data['response']['groups'][0]['items'][pl]['venue']['location']['address'];
                loc += ", " + data['response']['groups'][0]['items'][pl]['venue']['location']['city'];
                loc += ", " + data['response']['groups'][0]['items'][pl]['venue']['location']['state'];
                loc += ", " + data['response']['groups'][0]['items'][pl]['venue']['location']['cc'];

                waynames[cur - 1] = name;
                waypoints[cur - 1] = {
                    location: loc,
                    stopover: true
                };
            }

            function modAddresses(dirresult) {
                var modResult = dirresult;
                for(var i = 0; i < dirresult.routes[0].legs.length; i++) {
                    // check for waynames != n/a
                    if(i == 0) {
                        modResult.routes[0].legs[i].start_address = start;
                        modResult.routes[0].legs[i].end_address = waypoints[i].location;
                    } else if(i == (dirresult.routes[0].legs.length - 1)) {
                        modResult.routes[0].legs[i].start_address = waypoints[i - 1].location;
                        modResult.routes[0].legs[i].end_address = end;
                    } else {
                        modResult.routes[0].legs[i].start_address = waypoints[i - 1].location;
                        modResult.routes[0].legs[i].end_address = waypoints[i].location;
                    }

                }
                return modResult;
            }

            function placeMarker(location) {
                var marker = new google.maps.Marker({
                    position: location,
                    map: map
                });
                map.setCenter(location);
            }

            function errfunc(data) {
                console.log(data);
                $("#progressbar").hide('fast');
                $("#notifications").show('fast');
                $("#notifications").html("whoops! we ran into an error. try again!");
                document.getElementById("gobtn").disabled = false;
            }

            google.maps.event.addDomListener(window, 'load', initialize);
    	</script>
        <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-9519585-6']);
		_gaq.push(['_trackPageview']);
		
		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
		</script>
    </head>
    <body>
        <div id="control">
            <center>
            <h2>maproulette</h2>
            <div id="regform">
                <form id="regroute" name="route" onSubmit='JavaScript:return false;'>
                    start: <input id="regstart" type="text" name="start" size="40" />
                    end: <input id="regend" type="text" name="end" size="40" />
                    <input id="gobtn" type="submit" name="go" value="go" onClick="getRoute(this.form)"/>
                </form>
            </div>
            <div id="fsqform">
                <form id="fsqroute" name="route" onSubmit='JavaScript:return false;'>
                    start: <input id="fsqstart" type="text" name="start" size="40" />
                    end: <input id="fsqend" type="text" name="end" size="40" />
                    <br>
                    category: 
                    <select name="categories" size="3" id="sections">
                      <option value="all" selected>all</option>
                      <option value="food">food</option>
                      <option value="drinks">drinks</option>
                      <option value="coffee">coffee</option>
                      <option value="shops">shops</option>
                      <option value="arts">arts</option>
                      <option value="outdoors">outdoors</option>
                    </select>
                    search: <input id="search" type="text" name="search" size="40" />
                    <input type="checkbox" name="new" id="newrec" value="new" checked> new
                    <input type="checkbox" name="old" id="oldrec" value="old" checked> old
                    <input id="gobtn" type="submit" name="go" value="go" onClick="getRoute(this.form)"/>
                </form>
            </div>
            <div id="progressbar"></div>
            <div id="notifications"></div>
            <div id="foursquare" class="foursquare">
            	log in to <a href="javascript:doAuthRedirect()">foursquare</a> to get customized waypoints
            </div>
            </center>
        </div>
        <div id="directions-panel"></div>
        <div id="map_canvas"></div>
        <div id="footer" align="center">
     		<a href="about.html">about</a>
        </div>
    </body>
</html>